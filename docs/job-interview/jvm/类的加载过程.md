# 类的加载过程（类+接口）

系统加载 Class 类型的文件主要三步:**加载->连接->初始化**。连接过程又可分为三步:**验证->准备->解析**。

![类加载过程](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.png)



引用类型，Java 将其细分为四种：类、接口、数组类和泛型参数。由于泛型参数会在编译过程中被擦除，因此 Java 虚拟机实际上只有前三种。在类、接口和数组类中，数组类是由 Java 虚拟机直接生成的，其他两种则有对应的字节流。

## 加载（将二进制流加载成class对象）

`加载就是将二进制流变成内存中的一个Class`

加载，是指查找字节流，并且据此创建类的过程。数组类是由 Java 虚拟机直接生成的。对于其他的类来说，Java 虚拟机则需要借助类加载器来完成查找字节流的过程。

![类加载器](https://tva1.sinaimg.cn/large/006y8mN6ly1g9bqwpdmnej30cx09amxo.jpg)


### 双亲委派机制：
只有上级类加载器不能加载的情况下，下级类加载器才会去尝试加载。

* 启动类加载器：这个类加载器负责放在`<JAVA_HOME>\lib`目录中的，或者被-Xbootclasspath参数所指定的路径中的，并且是虚拟机识别的类库。用户无法直接使用。

* 扩展类加载器：这个类加载器由sun.misc.Launcher$AppClassLoader实现。它负责`<JAVA_HOME>\lib\ext`目录中的，或者被java.ext.dirs系统变量所指定的路径中的所有类库。用户可以直接使用。

* 应用程序类加载器：这个类由sun.misc.Launcher$AppClassLoader实现。是ClassLoader中getSystemClassLoader()方法的返回值。它负责用户路径（ClassPath）所指定的类库。用户可以直接使用。如果用户没有自己定义类加载器，默认使用这个。

* 自定义加载器：用户自己定义的类加载器。

## 验证（判断合法性）
验证阶段的目的，在于确保被加载类能够满足 Java 虚拟机的约束条件
![](https://tva1.sinaimg.cn/large/006y8mN6ly1g9bqzty2j9j30ej0cktal.jpg)
比较复杂

## 准备(为类的静态字段分配内存)
准备阶段的目的，则是为被加载类的静态字段分配内存。这个时候静态字段的值还都是各自类型的默认值，比如int是0，具体的赋值会在初始化阶段执行

## 解析（将符号引用转化为实际引用）
编译的时候，class文件无法知道自己调用的类、方法、字段所处的具体地址，因此，每当需要引用这些成员时，Java 编译器会生成一个符号引用。也就是方法限定符。
解析阶段的目的，正是将这些符号引用解析成为实际引用。如果符号引用指向一个未被加载的类，或者未被加载类的字段或方法，那么解析将触发这个类的加载（但未必触发这个类的链接以及初始化。）
## 初始化
> final修饰的基本类型和字符串都是进入常量池，其初始化由java虚拟机完成

除了上面的常量池数据，都会被放入<cinit>方法中，就是class对象的初始化范围。
1. 直接赋值的静态变量
2. 静态代码块中的代码

初始化的作用，就是给静态变量赋值。

## 触发类加载



* 当虚拟机启动时，初始化用户指定的主类；
* 当遇到用以新建目标类实例的 new 指令时，初始化 new 指令的目标类；
* 当遇到调用静态方法的指令时，初始化该静态方法所在的类；
* 当遇到访问静态字段的指令时，初始化该静态字段所在的类；
* 子类的初始化会触发父类的初始化；
* 如果一个接口定义了 default 方法，那么直接实现或者间接实现该接口的类的初始化，会触发该接口的初始化；
* 使用反射 API 对某个类进行反射调用时，初始化这个类；
* 当初次调用 MethodHandle 实例时，初始化该 MethodHandle 指向的方法所在的类。



## 使用类加载机制来实现单例

```java

public class Singleton {
  private Singleton() {}
  private static class LazyHolder {
    static final Singleton INSTANCE = new Singleton();
  }
  public static Singleton getInstance() {
    return LazyHolder.INSTANCE;
  }
}
```

```java
 static final Singleton INSTANCE = new Singleton(); 
```

会被放入<cinit>中，因为这个方法只会执行一次，所以能保证单例