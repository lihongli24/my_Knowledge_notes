# 秒杀系统设计

## 秒杀系统会出现的问题

1. 高并发
2. 超卖
3. 恶意请求
4. 链接暴露

## 高并发

秒杀的时候，请求量可能会变成1万qps,但是tomcat一般只能支撑几百，数据库最多也只能到一两千都得挂

### 应用服务器的高并发如何处理

1. 使用负载均衡，将流量分到多台应用服务器上
2. 可以使用一些规则，在网关层进行流量消除，比如ip地址之类的
3. 

### 数据的高并发如何处理

1. 数据预热到redis中
2. 扣减库存的时候先在redis中扣数量

## 超卖

1. 使用lua脚本，实现redis 加减库存原子性

   1. 减库存时：先检查数量，如果不够减直接返回false,如果够再减
2. 用户下单，先使用上面的逻辑减库存，如果库存不够，后面的用户直接返回失败
3. 如果减库存成功，走mq，创建订单，数据库减库存。
4. 需要定期扫描，可能存在已经下了订单但是长时间不支付的情况，这种情况需要把库存加回去
   1. 定时扫描数据库
   2. 创建订单的时候，发送一个延时mq